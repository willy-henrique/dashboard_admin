# Sistema Financeiro Completo

Este documento descreve o sistema financeiro desenvolvido com todas as funcionalidades solicitadas, incluindo integra√ß√µes externas e gest√£o segura de credenciais.

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura](#arquitetura)
3. [M√≥dulos Implementados](#m√≥dulos-implementados)
4. [Integra√ß√µes Externas](#integra√ß√µes-externas)
5. [Seguran√ßa](#seguran√ßa)
6. [Observabilidade](#observabilidade)
7. [Configura√ß√£o](#configura√ß√£o)
8. [Uso](#uso)
9. [Estrutura de Arquivos](#estrutura-de-arquivos)
10. [Pr√≥ximos Passos](#pr√≥ximos-passos)

## üéØ Vis√£o Geral

O sistema financeiro implementa um conjunto completo de funcionalidades para gest√£o financeira empresarial, incluindo:

- **Dashboard Financeiro**: KPIs, alertas e m√©tricas consolidadas
- **Gest√£o de Contas**: Contas banc√°rias, caixa e investimentos
- **Faturamento**: Clientes, produtos, NF-e/NFS-e, pagamentos
- **Fluxo de Caixa**: Entradas manuais e autom√°ticas, categorias, centros de custo
- **Folha de Pagamento**: Funcion√°rios, proventos, descontos, contracheques
- **Fechamento**: Per√≠odos, concilia√ß√£o, ajustes, previs√µes
- **Relat√≥rios**: PDF, Excel, CSV com filtros e agendamentos

## üèóÔ∏è Arquitetura

### Padr√µes Arquiteturais

- **Domain-Driven Design (DDD)**: Separa√ß√£o clara entre dom√≠nios
- **Clean Architecture**: Camadas bem definidas (domain, application, infrastructure)
- **Repository Pattern**: Abstra√ß√£o de acesso a dados
- **Factory Pattern**: Cria√ß√£o de integra√ß√µes
- **Strategy Pattern**: Diferentes implementa√ß√µes de integra√ß√µes

### Camadas da Aplica√ß√£o

```
src/
‚îú‚îÄ‚îÄ types/           # Defini√ß√µes de tipos TypeScript
‚îú‚îÄ‚îÄ lib/            # Utilit√°rios e configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ config.ts   # Configura√ß√£o centralizada
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts   # Sistema de logs estruturados
‚îÇ   ‚îú‚îÄ‚îÄ queue.ts    # Sistema de filas ass√≠ncronas
‚îÇ   ‚îú‚îÄ‚îÄ encryption.ts # Criptografia e seguran√ßa
‚îÇ   ‚îî‚îÄ‚îÄ integrations/ # Integra√ß√µes externas
‚îú‚îÄ‚îÄ services/       # Servi√ßos de dom√≠nio
‚îî‚îÄ‚îÄ controllers/    # Controladores da API (futuro)
```

## üì¶ M√≥dulos Implementados

### 1. Dashboard Financeiro (`DashboardService`)

**Funcionalidades:**
- KPIs financeiros (receita, despesas, lucro, contas a receber/pagar)
- Resumo do fluxo de caixa
- Alertas financeiros (vencimentos, saldo baixo, fluxo negativo)
- Saldos das contas
- Tend√™ncias financeiras

**M√©todos Principais:**
```typescript
// Obter dados completos do dashboard
await dashboardService.getDashboardData(userId, period);

// Calcular KPIs espec√≠ficos
await dashboardService.getKPIMetrics(period);

// Obter alertas financeiros
await dashboardService.getAlerts();
```

### 2. Gest√£o de Contas (`AccountService`)

**Funcionalidades:**
- CRUD de contas banc√°rias, caixa e investimentos
- Sincroniza√ß√£o com bancos via Open Finance
- Importa√ß√£o de extratos
- Gest√£o de transa√ß√µes
- Saldos em tempo real

**M√©todos Principais:**
```typescript
// Obter todas as contas
await accountService.getAccounts();

// Sincronizar com banco
await accountService.syncWithBank(accountId);

// Importar transa√ß√µes
await accountService.importTransactions(accountId, transactions);
```

### 3. Faturamento (`InvoiceService`)

**Funcionalidades:**
- CRUD de clientes e produtos
- Emiss√£o de NF-e/NFS-e
- Cria√ß√£o de cobran√ßas (PIX, Boleto, Cart√£o)
- Gest√£o de faturas e parcelas
- Cancelamento de documentos

**M√©todos Principais:**
```typescript
// Criar nova fatura
await invoiceService.createInvoice(invoiceData);

// Emitir NF-e
await invoiceService.issueNFE(invoiceId);

// Criar cobran√ßa PIX
await invoiceService.createPIXCharge(invoiceId);
```

### 4. Fluxo de Caixa (`CashFlowService`)

**Funcionalidades:**
- Entradas manuais e autom√°ticas
- Categoriza√ß√£o de receitas e despesas
- Centros de custo
- Filtros avan√ßados
- Estat√≠sticas e relat√≥rios

**M√©todos Principais:**
```typescript
// Criar entrada no fluxo de caixa
await cashFlowService.createEntry(entryData);

// Obter estat√≠sticas
await cashFlowService.getStatistics(period);

// Importar entradas
await cashFlowService.importEntries(entries);
```

### 5. Folha de Pagamento (`PayrollService`)

**Funcionalidades:**
- Gest√£o de funcion√°rios
- Proventos e descontos
- Gera√ß√£o de contracheques
- Cobran√ßas da folha
- Processamento autom√°tico

**M√©todos Principais:**
```typescript
// Processar folha de pagamento
await payrollService.processPayroll(period);

// Gerar contracheque
await payrollService.generatePayslip(employeeId, period);

// Obter estat√≠sticas
await payrollService.getStatistics(period);
```

### 6. Fechamento (`ClosingService`)

**Funcionalidades:**
- Per√≠odos de fechamento
- Concilia√ß√£o autom√°tica
- Ajustes manuais
- Previs√µes vs. realizados
- Bloqueio de per√≠odos

**M√©todos Principais:**
```typescript
// Bloquear per√≠odo
await closingService.lockPeriod(periodId, userId);

// Executar concilia√ß√£o autom√°tica
await closingService.performAutomaticReconciliation(periodId);

// Criar ajuste
await closingService.createAdjustment(adjustmentData);
```

### 7. Relat√≥rios (`ReportService`)

**Funcionalidades:**
- Gera√ß√£o de relat√≥rios (PDF, Excel, CSV)
- Templates personaliz√°veis
- Agendamento autom√°tico
- Filtros avan√ßados
- Estat√≠sticas de execu√ß√£o

**M√©todos Principais:**
```typescript
// Gerar relat√≥rio
await reportService.generateReport(type, format, filter, createdBy);

// Executar agendamentos
await reportService.executeScheduledReports();

// Obter estat√≠sticas
await reportService.getStatistics(period);
```

## üîå Integra√ß√µes Externas

### 1. Bancos (Open Finance)

**Implementa√ß√£o:** `BankIntegration`
- **Sandbox Mode**: Dados mock para desenvolvimento
- **Open Finance**: Integra√ß√£o real com APIs banc√°rias
- **Funcionalidades:**
  - Consulta de saldos
  - Importa√ß√£o de extratos
  - Transfer√™ncias
  - Webhooks para atualiza√ß√µes

```typescript
// Testar conex√£o
await bankIntegration.testConnection();

// Obter saldo
await bankIntegration.getBalance(accountId);

// Importar extratos
await bankIntegration.getStatements(accountId, startDate, endDate);
```

### 2. Fiscal (SEFAZ/Munic√≠pio)

**Implementa√ß√£o:** `FiscalIntegration`
- **NF-e**: Nota Fiscal Eletr√¥nica
- **NFS-e**: Nota Fiscal de Servi√ßos Eletr√¥nica
- **Funcionalidades:**
  - Emiss√£o de documentos
  - Consulta de status
  - Cancelamento
  - Webhooks para atualiza√ß√µes

```typescript
// Emitir NF-e
await nfeIntegration.issue(invoiceData);

// Consultar status
await nfeIntegration.query(documentId);

// Cancelar documento
await nfeIntegration.cancel(documentId, reason);
```

### 3. Pagamentos (PSPs)

**Implementa√ß√£o:** `PaymentIntegration`
- **Sandbox Mode**: Dados mock para desenvolvimento
- **MercadoPago**: Integra√ß√£o real com gateway
- **Funcionalidades:**
  - PIX
  - Boleto
  - Cart√£o de cr√©dito
  - Webhooks para confirma√ß√µes

```typescript
// Criar cobran√ßa PIX
await paymentIntegration.createPIXCharge(chargeData);

// Criar boleto
await paymentIntegration.createBoletoCharge(chargeData);

// Consultar status
await paymentIntegration.getChargeStatus(chargeId);
```

## üîí Seguran√ßa

### 1. Gest√£o de Credenciais

- **Vari√°veis de Ambiente**: Todas as credenciais via ENV
- **Criptografia**: AES-256-GCM para dados sens√≠veis
- **Mascaramento**: Logs n√£o exp√µem dados sens√≠veis
- **Rota√ß√£o**: Suporte a rota√ß√£o de chaves

### 2. Criptografia

```typescript
// Criptografar dados
const encrypted = await encryptionService.encryptString(sensitiveData);

// Descriptografar dados
const decrypted = await encryptionService.decryptString(encrypted);

// Hash seguro
const hashed = await encryptionService.hashString(password);
```

### 3. Logs Seguros

```typescript
// Logs autom√°ticos com mascaramento
logger.info('Opera√ß√£o realizada', { 
  userId, 
  amount: 1000, // Mascarado automaticamente
  accountId: 'acc-123' // Mascarado automaticamente
});
```

## üìä Observabilidade

### 1. Logs Estruturados

- **JSON em produ√ß√£o**: Para agrega√ß√£o e an√°lise
- **Formato leg√≠vel em desenvolvimento**: Para debug
- **N√≠veis**: error, warn, info, debug, trace
- **Contexto**: userId, requestId, opera√ß√£o

### 2. M√©tricas

- **Tempo de execu√ß√£o**: Para todas as opera√ß√µes
- **Taxa de sucesso**: Para integra√ß√µes
- **Volume de dados**: Para relat√≥rios
- **Uso de recursos**: Para otimiza√ß√£o

### 3. Rastreamento

- **Request ID**: Rastreamento de requisi√ß√µes
- **Correlation ID**: Rastreamento entre servi√ßos
- **Audit Trail**: Log de todas as opera√ß√µes

## ‚öôÔ∏è Configura√ß√£o

### 1. Vari√°veis de Ambiente

Crie um arquivo `.env` baseado no `.env.example`:

```bash
# Core
NODE_ENV=development
PORT=3000
DATABASE_URL=postgresql://user:pass@localhost:5432/financial_db
REDIS_URL=redis://localhost:6379

# Seguran√ßa
ENCRYPTION_KEY=your-32-character-encryption-key
JWT_SECRET=your-jwt-secret

# Integra√ß√µes
BANK_INTEGRATION_ENABLED=true
BANK_SANDBOX_MODE=true
FISCAL_INTEGRATION_ENABLED=true
PAYMENT_INTEGRATION_ENABLED=true
```

### 2. Verifica√ß√£o de Configura√ß√£o

```typescript
// Verificar status das integra√ß√µes
const bankStatus = config.getIntegrationStatus('bank');
const fiscalStatus = config.getIntegrationStatus('fiscal');
const paymentStatus = config.getIntegrationStatus('payment');
```

## üöÄ Uso

### 1. Inicializa√ß√£o

```typescript
import { 
  DashboardService, 
  AccountService, 
  InvoiceService,
  config,
  logger 
} from './services';

// Verificar configura√ß√£o
if (!config.isValid()) {
  logger.error('Configura√ß√£o inv√°lida');
  process.exit(1);
}

// Inicializar servi√ßos
const dashboardService = new DashboardService();
const accountService = new AccountService();
const invoiceService = new InvoiceService();
```

### 2. Exemplo de Uso Completo

```typescript
// Obter dashboard financeiro
const dashboardData = await dashboardService.getDashboardData('user-123', 'current');

// Criar nova conta
const account = await accountService.createAccount({
  name: 'Conta Principal',
  type: 'checking',
  bankCode: '001',
  agency: '1234',
  account: '123456-7'
});

// Criar fatura
const invoice = await invoiceService.createInvoice({
  clientId: 'client-123',
  items: [
    { productId: 'prod-1', quantity: 2, unitPrice: 100 }
  ],
  dueDate: '2024-02-15'
});

// Emitir NF-e
await invoiceService.issueNFE(invoice.id);

// Criar cobran√ßa PIX
await invoiceService.createPIXCharge(invoice.id);
```

### 3. Integra√ß√£o com Filas

```typescript
import { queue } from './services';

// Adicionar job para processamento ass√≠ncrono
await queue.add('process-invoice', {
  invoiceId: 'inv-123',
  userId: 'user-456'
}, {
  priority: 1,
  delay: 5000 // 5 segundos
});

// Processar jobs
queue.process('process-invoice', async (job) => {
  const { invoiceId, userId } = job.data;
  await invoiceService.processInvoice(invoiceId, userId);
});
```

## üìÅ Estrutura de Arquivos

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ finance.ts              # Tipos TypeScript do sistema financeiro
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ config.ts               # Configura√ß√£o centralizada
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts               # Sistema de logs
‚îÇ   ‚îú‚îÄ‚îÄ queue.ts                # Sistema de filas
‚îÇ   ‚îú‚îÄ‚îÄ encryption.ts           # Criptografia
‚îÇ   ‚îî‚îÄ‚îÄ integrations/
‚îÇ       ‚îú‚îÄ‚îÄ bank.ts             # Integra√ß√£o banc√°ria
‚îÇ       ‚îú‚îÄ‚îÄ fiscal.ts           # Integra√ß√£o fiscal
‚îÇ       ‚îî‚îÄ‚îÄ payments.ts         # Integra√ß√£o de pagamentos
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                # Exporta√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ AccountService.ts       # Gest√£o de contas
‚îÇ   ‚îú‚îÄ‚îÄ InvoiceService.ts       # Faturamento
‚îÇ   ‚îú‚îÄ‚îÄ DashboardService.ts     # Dashboard financeiro
‚îÇ   ‚îú‚îÄ‚îÄ CashFlowService.ts      # Fluxo de caixa
‚îÇ   ‚îú‚îÄ‚îÄ PayrollService.ts       # Folha de pagamento
‚îÇ   ‚îú‚îÄ‚îÄ ClosingService.ts       # Fechamento
‚îÇ   ‚îî‚îÄ‚îÄ ReportService.ts        # Relat√≥rios
‚îî‚îÄ‚îÄ controllers/                # Futuro: controladores da API
```

## üîÑ Pr√≥ximos Passos

### 1. Implementa√ß√µes Pendentes

- [ ] **API REST**: Endpoints para todos os servi√ßos
- [ ] **Autentica√ß√£o**: JWT/OAuth2 com RBAC
- [ ] **Banco de Dados**: PostgreSQL com migrations
- [ ] **Testes**: Unit, integration e API contract tests
- [ ] **CI/CD**: Pipelines com verifica√ß√£o de secrets
- [ ] **M√©tricas**: Prometheus/Grafana
- [ ] **Tracing**: Jaeger/Zipkin
- [ ] **Scheduler**: Cron jobs para tarefas autom√°ticas

### 2. Melhorias Futuras

- [ ] **Cache**: Redis para performance
- [ ] **Rate Limiting**: Prote√ß√£o contra abuso
- [ ] **Webhooks**: Endpoints para integra√ß√µes
- [ ] **Audit Trail**: Log completo de todas as opera√ß√µes
- [ ] **Backup**: Estrat√©gia de backup autom√°tico
- [ ] **Monitoramento**: Alertas e dashboards
- [ ] **Documenta√ß√£o**: API docs com Swagger
- [ ] **Deploy**: Docker e Kubernetes

### 3. Integra√ß√µes Adicionais

- [ ] **Email**: SendGrid/Mailgun para notifica√ß√µes
- [ ] **SMS**: Twilio para alertas
- [ ] **Storage**: AWS S3 para arquivos
- [ ] **OAuth**: Google/Microsoft para login empresarial
- [ ] **Mais Bancos**: Outros provedores Open Finance
- [ ] **Mais PSPs**: Outros gateways de pagamento

## üìû Suporte

Para d√∫vidas ou suporte:

1. **Documenta√ß√£o**: Consulte este README
2. **Logs**: Verifique os logs estruturados
3. **Configura√ß√£o**: Valide as vari√°veis de ambiente
4. **Integra√ß√µes**: Teste as conex√µes via m√©todos `testConnection()`

## üìÑ Licen√ßa

Este sistema foi desenvolvido como parte do projeto de painel administrativo. Todos os direitos reservados.



